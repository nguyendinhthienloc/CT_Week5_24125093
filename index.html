<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>T√¨m ƒêi·ªÉm Du L·ªãch Vi·ªát Nam</title>
  
  <!-- Favicon -->
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üó∫Ô∏è</text></svg>">
  
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    * {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Noto Sans', sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
    }
    
    /* Ensure emojis and Vietnamese characters render properly */
    body {
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      text-rendering: optimizeLegibility;
    }
    
    h1, h2 {
      font-weight: 700;
      letter-spacing: -0.025em;
    }
    
    #map {
      height: 600px;
      width: 100%;
      border-radius: 16px;
      box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
      border: 2px solid rgba(255, 255, 255, 0.8);
    }
    
    .poi-card {
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      cursor: pointer;
      border: 2px solid transparent;
    }
    
    .poi-card:hover {
      transform: translateY(-4px) scale(1.02);
      box-shadow: 0 12px 24px -4px rgba(0, 0, 0, 0.2);
      border-color: #3b82f6;
    }
    
    .quick-search {
      transition: all 0.2s ease;
      border: 2px solid transparent;
    }
    
    .quick-search:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(59, 130, 246, 0.3);
      border-color: #3b82f6;
    }
    
    .quick-search:active {
      transform: scale(0.95);
    }
    
    .loading-spinner {
      border: 4px solid #e5e7eb;
      border-top: 4px solid #3b82f6;
      border-radius: 50%;
      width: 48px;
      height: 48px;
      animation: spin 0.8s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    
    .marker-icon {
      background-color: #3b82f6;
      border: 3px solid white;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    }
    
    .search-input-wrapper {
      position: relative;
    }
    
    .search-input-wrapper::before {
      content: 'üîç';
      position: absolute;
      left: 16px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 20px;
      pointer-events: none;
      z-index: 10;
    }
    
    #locationInput {
      padding-left: 48px !important;
    }
    
    .feature-badge {
      display: inline-block;
      padding: 4px 12px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      margin-right: 8px;
      box-shadow: 0 2px 4px rgba(102, 126, 234, 0.3);
    }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100">
  <div class="container mx-auto px-4 py-8">
    

    <!-- Header -->
    <div class="text-center mb-8">
      <h1 class="text-5xl font-bold mb-3 inline-block">
        <span class="bg-gradient-to-r from-blue-500 to-purple-600 text-white px-6 py-3 rounded-2xl shadow-lg">
          üó∫Ô∏è Kh√°m Ph√° Vi·ªát Nam
        </span>
      </h1>
      <!-- moved down -->
      <div class="flex justify-center gap-2 flex-wrap">
        <span class="feature-badge">üéØ T√¨m ki·∫øm nhanh</span>
        <span class="feature-badge">üìç 5 ƒëi·ªÉm th√∫ v·ªã</span>
        <span class="feature-badge">üó®Ô∏è Mi·ªÖn ph√≠ 100%</span>
      </div>
    </div>

    <!-- BEGIN: Quick Translator (EN ‚Üí VI) -->
    <div id="quickTranslator" class="bg-white rounded-2xl shadow-xl p-6 mb-6 border border-gray-100">
      <h3 class="text-lg font-semibold mb-3">D·ªãch nhanh (EN ‚Üí VI)</h3>

      <div class="grid gap-3 md:grid-cols-[1fr_auto]">
        <textarea id="txtToTranslate" rows="3"
          placeholder="Type English text here... / Vi·∫øt ti·∫øng Anh ·ªü ƒë√¢y..."
          class="w-full px-4 py-3 rounded-xl border border-slate-200 bg-slate-50 focus:bg-white focus:outline-none focus:ring-4 focus:ring-blue-100 resize-none"></textarea>

        <div class="flex flex-col gap-2">
          <button id="btnTranslate" class="px-5 py-3 rounded-xl bg-blue-600 text-white font-semibold shadow hover:bg-blue-700">
            D·ªãch ‚Üí VN
          </button>
          <button id="btnClear" class="px-5 py-3 rounded-xl bg-slate-100 text-sm font-medium hover:bg-slate-200">
            X√≥a
          </button>
        </div>
      </div>

      <div id="translateStatus" class="mt-4 text-sm text-slate-500 hidden"></div>

      <div id="translateResult" class="mt-4 hidden">
        <label class="text-xs font-semibold text-slate-600">K·∫øt qu·∫£ (Ti·∫øng Vi·ªát)</label>
        <div id="translatedText" class="mt-2 p-4 rounded-lg bg-slate-50 border border-slate-200 text-slate-800"></div>
      </div>
    </div>
    <!-- END: Quick Translator -->

    <!-- Search Section -->
    <div class="bg-white rounded-2xl shadow-xl p-8 mb-6 border border-gray-100">
      <div class="flex gap-4 flex-col sm:flex-row">
        <div class="flex-1">
          <label class="block text-sm font-bold text-gray-800 mb-3 flex items-center gap-2">
            <span>üìå</span>
            <span>Nh·∫≠p t√™n ƒë·ªãa ƒëi·ªÉm ·ªü Vi·ªát Nam:</span>
          </label>
          <div class="search-input-wrapper">
            <input 
              type="text" 
              id="locationInput" 
              placeholder="V√≠ d·ª•: H√† N·ªôi, ƒê√† N·∫µng, H·ªôi An, Nha Trang..."
              class="w-full px-4 py-4 border-2 border-gray-200 rounded-xl focus:ring-4 focus:ring-blue-200 focus:border-blue-500 transition-all text-lg"
              autocomplete="off"
            />
          </div>
        </div>
        <div class="flex items-end">
          <button 
            id="searchBtn" 
            class="w-full sm:w-auto px-8 py-4 bg-gradient-to-r from-blue-600 to-blue-700 text-white font-bold rounded-xl hover:from-blue-700 hover:to-blue-800 active:scale-95 transition-all shadow-lg hover:shadow-xl"
          >
            üîç T√¨m ki·∫øm
          </button>
        </div>
      </div>
      
      <!-- Loading indicator -->
      <div id="loading" class="hidden mt-6 flex items-center justify-center p-6 bg-blue-50 rounded-xl">
        <div class="loading-spinner"></div>
        <span class="ml-4 text-blue-700 font-semibold text-lg">ƒêang t√¨m ki·∫øm ƒëi·ªÉm th√∫ v·ªã...</span>
      </div>
      
      <!-- Error message -->
      <div id="errorMsg" class="hidden mt-6 p-5 bg-red-50 border-2 border-red-300 text-red-800 rounded-xl font-medium"></div>
      
      <!-- Quick search buttons -->
      <div class="mt-6">
        <p class="text-sm font-semibold text-gray-700 mb-3 flex items-center gap-2">
          <span>‚ö°</span>
          <span>Ho·∫∑c ch·ªçn ƒë·ªãa ƒëi·ªÉm ph·ªï bi·∫øn:</span>
        </p>
        <div class="flex flex-wrap gap-3">
          <button class="quick-search px-5 py-2.5 bg-gradient-to-r from-gray-50 to-gray-100 hover:from-blue-50 hover:to-blue-100 rounded-full text-sm font-semibold shadow-sm" data-location="H√† N·ªôi">
            üìç H√† N·ªôi
          </button>
          <button class="quick-search px-5 py-2.5 bg-gradient-to-r from-gray-50 to-gray-100 hover:from-blue-50 hover:to-blue-100 rounded-full text-sm font-semibold shadow-sm" data-location="H·ªôi An">
            üèÆ H·ªôi An
          </button>
          <button class="quick-search px-5 py-2.5 bg-gradient-to-r from-gray-50 to-gray-100 hover:from-blue-50 hover:to-blue-100 rounded-full text-sm font-semibold shadow-sm" data-location="ƒê√† N·∫µng">
            üåä ƒê√† N·∫µng
          </button>
          <button class="quick-search px-5 py-2.5 bg-gradient-to-r from-gray-50 to-gray-100 hover:from-blue-50 hover:to-blue-100 rounded-full text-sm font-semibold shadow-sm" data-location="Nha Trang">
            üèñÔ∏è Nha Trang
          </button>
          <button class="quick-search px-5 py-2.5 bg-gradient-to-r from-gray-50 to-gray-100 hover:from-blue-50 hover:to-blue-100 rounded-full text-sm font-semibold shadow-sm" data-location="S√†i G√≤n">
            üèôÔ∏è S√†i G√≤n
          </button>
          <button class="quick-search px-5 py-2.5 bg-gradient-to-r from-gray-50 to-gray-100 hover:from-blue-50 hover:to-blue-100 rounded-full text-sm font-semibold shadow-sm" data-location="Ph√∫ Qu·ªëc">
            üèùÔ∏è Ph√∫ Qu·ªëc
          </button>
          <button class="quick-search px-5 py-2.5 bg-gradient-to-r from-gray-50 to-gray-100 hover:from-blue-50 hover:to-blue-100 rounded-full text-sm font-semibold shadow-sm" data-location="Hu·∫ø">
            üëë Hu·∫ø
          </button>
          <button class="quick-search px-5 py-2.5 bg-gradient-to-r from-gray-50 to-gray-100 hover:from-blue-50 hover:to-blue-100 rounded-full text-sm font-semibold shadow-sm" data-location="ƒê√† L·∫°t">
            üåπ ƒê√† L·∫°t
          </button>
          <button class="quick-search px-5 py-2.5 bg-gradient-to-r from-gray-50 to-gray-100 hover:from-blue-50 hover:to-blue-100 rounded-full text-sm font-semibold shadow-sm" data-location="S√≥c TrƒÉng">
            üåæ S√≥c TrƒÉng
          </button>
        </div>
      </div>
    </div>

      <!-- Translation Bar (English ‚Üí Vietnamese) -->
      <div id="translateSection" class="mt-6 bg-white rounded-2xl p-6 border border-gray-100">
        <h3 class="text-lg font-semibold mb-3">üî§ D·ªãch nhanh (English ‚Üí Ti·∫øng Vi·ªát)</h3>
        <div class="flex gap-3 flex-col sm:flex-row">
          <textarea id="translateInput" rows="2" placeholder="Paste or type English text here..." class="flex-1 px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-4 focus:ring-blue-200 focus:border-blue-500 resize-none"></textarea>
          <div class="flex-shrink-0 flex flex-col items-stretch gap-3">
            <button id="translateBtn" class="px-6 py-3 bg-gradient-to-r from-green-500 to-green-600 text-white rounded-xl font-semibold shadow hover:from-green-600 active:scale-95">D·ªãch</button>
            <button id="clearTranslateBtn" class="px-6 py-3 bg-gray-100 text-gray-700 rounded-xl">Xo√°</button>
          </div>
        </div>
        <div id="translateResult" class="mt-4 hidden bg-gray-50 p-4 rounded-lg border border-gray-200">
          <div class="text-sm text-gray-500 mb-2">K·∫øt qu·∫£ (Ti·∫øng Vi·ªát):</div>
          <div id="translatedText" class="text-gray-900 font-medium"></div>
          <div class="mt-3 flex gap-2">
            <button id="copyTranslateBtn" class="px-3 py-2 bg-blue-600 text-white rounded-md text-sm">Sao ch√©p</button>
            <button id="openInNewBtn" class="px-3 py-2 bg-white border text-sm rounded-md">M·ªü trong tab m·ªõi</button>
          </div>
        </div>
      </div>

      <!-- Weather Section -->
    <div id="weatherSection" class="hidden">
      <div class="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-2xl shadow-xl p-8 mb-6 border-2 border-blue-200">
        <h2 class="text-3xl font-bold text-gray-800 mb-5 flex items-center gap-3">
          <span class="text-4xl">üå§Ô∏è</span>
          <span>Weather Information</span>
        </h2>
        <div id="weatherContent" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4"></div>
      </div>
    </div>

    <!-- Points of Interest Section (moved before map) -->
    <div id="poiSection" class="hidden">
      <div class="bg-white rounded-2xl shadow-xl p-8 mb-6 border border-gray-100">
        <h2 class="text-3xl font-bold text-gray-800 mb-6 flex items-center gap-3">
          <span class="text-4xl">üìç</span>
          <span>5 ƒêi·ªÉm Th√∫ V·ªã G·∫ßn ƒê√≥</span>
        </h2>
        <div id="poiList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5"></div>
      </div>
    </div>

    <!-- Map Section -->
    <div class="bg-white rounded-2xl shadow-xl p-8 mb-6 border border-gray-100">
      <h2 class="text-3xl font-bold text-gray-800 mb-5 flex items-center gap-3">
        <span class="text-4xl">üó∫Ô∏è</span>
        <span>B·∫£n ƒë·ªì</span>
      </h2>
      <div id="map"></div>
      <p class="text-xs text-gray-500 mt-3 text-center">
        üí° <strong>M·∫πo:</strong> Click v√†o marker tr√™n b·∫£n ƒë·ªì ho·∫∑c th·∫ª b√™n tr√™n ƒë·ªÉ xem chi ti·∫øt
      </p>
    </div>
    
    <!-- Debug Info (toggle with Ctrl+Shift+D) -->
    <div id="debugPanel" class="hidden fixed bottom-4 right-4 bg-gray-900 text-white p-4 rounded-lg shadow-2xl max-w-md text-xs font-mono">
      <div class="flex justify-between items-center mb-2">
        <span class="font-bold">üîç Debug Info</span>
        <button onclick="document.getElementById('debugPanel').classList.add('hidden')" class="text-gray-400 hover:text-white">‚úï</button>
      </div>
      <div id="debugContent"></div>
    </div>
  </div>

  <!-- Leaflet JavaScript -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  
  <script>
    // Initialize map centered on Vietnam
    let map = L.map('map').setView([16.0544, 108.2022], 6);
    
    // Add OpenStreetMap tiles
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '¬© OpenStreetMap contributors',
      maxZoom: 19
    }).addTo(map);
    
    let markers = [];
    let currentLocation = null;
    let searchCache = new Map(); // Cache for search results
    
    // OpenWeatherMap API key (free tier)
    const WEATHER_API_KEY = '4d8fb5b93d4af21d66a2948710284366'; // Demo KEY
    
    // Get DOM elements
    const searchBtn = document.getElementById('searchBtn');
    const locationInput = document.getElementById('locationInput');
    const loading = document.getElementById('loading');
    const errorMsg = document.getElementById('errorMsg');
    const poiSection = document.getElementById('poiSection');
    const poiList = document.getElementById('poiList');
    const weatherSection = document.getElementById('weatherSection');
    const weatherContent = document.getElementById('weatherContent');
    
    // Search function
    async function searchLocation() {
      const query = locationInput.value.trim();
      
      if (!query) {
        showError('Vui l√≤ng nh·∫≠p t√™n ƒë·ªãa ƒëi·ªÉm!');
        return;
      }
      
        // Clear previous results
        clearMarkers();
        hideError();
        poiSection.classList.add('hidden');
        weatherSection.classList.add('hidden');
        loading.classList.remove('hidden');      try {
        // Check cache first
        const cacheKey = query.toLowerCase();
        if (searchCache.has(cacheKey)) {
          console.log('Using cached results for:', query);
          const cached = searchCache.get(cacheKey);
          currentLocation = cached.location;
          map.setView([currentLocation.lat, currentLocation.lon], 14);
          
          const mainMarker = L.marker([currentLocation.lat, currentLocation.lon], {
            icon: L.divIcon({
              className: 'custom-marker',
              html: `<div style="background-color: #ef4444; border: 3px solid white; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; box-shadow: 0 2px 8px rgba(0,0,0,0.3); font-size: 20px;">üìç</div>`,
              iconSize: [40, 40],
              iconAnchor: [20, 40]
            })
          }).addTo(map);
          
          mainMarker.bindPopup(`<b>${query}</b><br>${currentLocation.name}`).openPopup();
          markers.push(mainMarker);
          
          displayPOIs(cached.pois);
          loading.classList.add('hidden');
          
          // Show cached weather if available
          if (cached.weather) {
            displayWeather(cached.weather);
          }
          return;
        }
        
        // Step 1: Geocode the location using Nominatim
        // Geocode via backend proxy
        const geocodeResponse = await fetch('http://localhost:8001/api/geocode', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ q: query + ', Vietnam', limit: 1 })
        });
        const geocodeData = await geocodeResponse.json();
        
        if (geocodeData.length === 0) {
          throw new Error('Kh√¥ng t√¨m th·∫•y ƒë·ªãa ƒëi·ªÉm. Vui l√≤ng th·ª≠ l·∫°i v·ªõi t√™n kh√°c.');
        }
        
        const location = geocodeData[0];
        currentLocation = {
          lat: parseFloat(location.lat),
          lon: parseFloat(location.lon),
          name: location.display_name
        };
        
        // Center map on location
        map.setView([currentLocation.lat, currentLocation.lon], 14);
        
        // Add main location marker
        const mainMarker = L.marker([currentLocation.lat, currentLocation.lon], {
          icon: L.divIcon({
            className: 'custom-marker',
            html: `<div style="background-color: #ef4444; border: 3px solid white; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; box-shadow: 0 2px 8px rgba(0,0,0,0.3); font-size: 20px;">üìç</div>`,
            iconSize: [40, 40],
            iconAnchor: [20, 40]
          })
        }).addTo(map);
        
        mainMarker.bindPopup(`<b>${query}</b><br>${currentLocation.name}`).openPopup();
        markers.push(mainMarker);
        
        // Step 2: Find points of interest via backend proxy (Overpass + fallback)
        await findPointsOfInterest(currentLocation.lat, currentLocation.lon);
        
        // Step 3: Fetch weather data via backend proxy
        await fetchWeather(currentLocation.lat, currentLocation.lon, query);
        
      } catch (error) {
        showError(error.message);
      } finally {
        loading.classList.add('hidden');
      }
    }
    
    // Fetch weather data from OpenWeatherMap API
    async function fetchWeather(lat, lon, locationName) {
      try {
        // Call local backend proxy for weather
        const response = await fetch('http://localhost:8001/api/weather', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ lat, lon })
        });
        if (!response.ok) {
          console.warn('Weather API error:', response.status);
          return;
        }
        
        const data = await response.json();
        console.log('Weather data:', data);
        
        const weatherData = {
          temp: Math.round(data.main.temp),
          feels_like: Math.round(data.main.feels_like),
          humidity: data.main.humidity,
          pressure: data.main.pressure,
          description: data.weather[0].description,
          icon: data.weather[0].icon,
          wind_speed: data.wind.speed,
          clouds: data.clouds.all,
          location: locationName
        };
        
        displayWeather(weatherData);
        
        // Cache weather data
        if (locationInput.value.trim()) {
          const cacheKey = locationInput.value.trim().toLowerCase();
          const cached = searchCache.get(cacheKey) || {};
          cached.weather = weatherData;
          searchCache.set(cacheKey, cached);
        }
        
      } catch (error) {
        console.error('Weather fetch error:', error);
        // Don't show error to user, weather is optional feature
      }
    }
    
    // Display weather information
    function displayWeather(weather) {
      weatherSection.classList.remove('hidden');
      
      const iconUrl = `https://openweathermap.org/img/wn/${weather.icon}@2x.png`;
      
      weatherContent.innerHTML = `
        <div class="bg-white rounded-xl p-6 shadow-lg border-2 border-blue-200">
          <div class="flex items-center justify-between mb-3">
            <div>
              <div class="text-5xl font-bold text-gray-800">${weather.temp}¬∞C</div>
              <div class="text-sm text-gray-600 mt-1">Feels like ${weather.feels_like}¬∞C</div>
            </div>
            <img src="${iconUrl}" alt="${weather.description}" class="w-20 h-20">
          </div>
          <div class="text-lg font-semibold text-gray-700 capitalize">${weather.description}</div>
        </div>
        
        <div class="bg-white rounded-xl p-6 shadow-lg border-2 border-blue-200">
          <div class="flex items-center gap-3 mb-4">
            <span class="text-3xl">üí®</span>
            <div>
              <div class="text-sm text-gray-600">Wind Speed</div>
              <div class="text-2xl font-bold text-gray-800">${weather.wind_speed} m/s</div>
            </div>
          </div>
          <div class="flex items-center gap-3">
            <span class="text-3xl">‚òÅÔ∏è</span>
            <div>
              <div class="text-sm text-gray-600">Cloudiness</div>
              <div class="text-2xl font-bold text-gray-800">${weather.clouds}%</div>
            </div>
          </div>
        </div>
        
        <div class="bg-white rounded-xl p-6 shadow-lg border-2 border-blue-200">
          <div class="flex items-center gap-3 mb-4">
            <span class="text-3xl">üíß</span>
            <div>
              <div class="text-sm text-gray-600">Humidity</div>
              <div class="text-2xl font-bold text-gray-800">${weather.humidity}%</div>
            </div>
          </div>
          <div class="flex items-center gap-3">
            <span class="text-3xl">üå°Ô∏è</span>
            <div>
              <div class="text-sm text-gray-600">Pressure</div>
              <div class="text-2xl font-bold text-gray-800">${weather.pressure} hPa</div>
            </div>
          </div>
        </div>
        
        <div class="bg-gradient-to-br from-blue-500 to-indigo-600 rounded-xl p-6 shadow-lg text-white">
          <div class="text-2xl font-bold mb-2">üìç ${weather.location}</div>
          <div class="text-sm opacity-90">Current weather conditions</div>
          <div class="mt-4 pt-4 border-t border-white border-opacity-30">
            <div class="text-xs opacity-75">Data from OpenWeatherMap</div>
          </div>
        </div>
      `;
    }
    
    // Find points of interest using Overpass API
    async function findPointsOfInterest(lat, lon) {
      try {
        console.log('Searching for POIs via backend for:', lat, lon);
        const response = await fetch('http://localhost:8001/api/poi', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ lat, lon, radius: 3000 })
        });

        if (!response.ok) {
          throw new Error('POI proxy error: ' + response.status);
        }

        const data = await response.json();

        if (data.fallback && data.pois) {
          console.log('Using fallback POIs from backend');
          displayPOIs(data.pois);
          return;
        }

        if (data.elements && data.elements.length > 0) {
          const pois = processPOIs(data.elements);
          displayPOIs(pois);
          return;
        }

        // No results returned
        console.log('No POIs returned from backend');
        showError('Kh√¥ng t√¨m th·∫•y ƒëi·ªÉm th√∫ v·ªã.');
        
      } catch (error) {
        console.error('POI search error:', error);
        showError('L·ªói khi t√¨m ki·∫øm ƒëi·ªÉm th√∫ v·ªã: ' + (error.message || error));
      }
    }
    
    // Fallback handled server-side now; keep this function as a no-op placeholder
    async function findPOIsFallback(lat, lon) {
      console.log('Client fallback disabled; server-side fallback should handle missing POIs.');
    }
    
    // Helper function to get icon based on category
    function getIconForCategory(category) {
      const iconMap = {
        'restaurant': 'üçΩÔ∏è',
        'cafe': '‚òï',
        'museum': 'üèõÔ∏è',
        'park': 'üå≥',
        'hotel': 'üè®',
        'shop': 'üõçÔ∏è',
        'tourism': 'üéØ',
        'amenity': 'üìç',
        'historic': 'üèõÔ∏è',
        'leisure': 'üéÆ'
      };
      return iconMap[category] || 'üìç';
    }
    
    // Process POI data
    function processPOIs(elements) {
      const pois = [];
      const seenNames = new Set();
      
      // Filter elements to only those with names and valid tags
      const validElements = elements.filter(el => {
        const tags = el.tags || {};
        return tags.name && (tags.tourism || tags.amenity || tags.historic || tags.leisure || tags.shop || tags.building);
      });
      
      console.log('Valid named elements:', validElements.length);
      
      for (const element of validElements) {
        if (pois.length >= 5) break;
        
        let lat, lon;
        
        if (element.type === 'node') {
          lat = element.lat;
          lon = element.lon;
        } else if (element.type === 'way' && element.center) {
          lat = element.center.lat;
          lon = element.center.lon;
        } else if (element.type === 'way' && element.bounds) {
          // Calculate center from bounds
          lat = (element.bounds.minlat + element.bounds.maxlat) / 2;
          lon = (element.bounds.minlon + element.bounds.maxlon) / 2;
        } else {
          continue;
        }
        
        const tags = element.tags || {};
        const name = tags.name || tags['name:vi'] || tags['name:en'] || 'Kh√¥ng c√≥ t√™n';
        
        // Skip unnamed or duplicate entries
        if (name === 'Kh√¥ng c√≥ t√™n' || seenNames.has(name)) continue;
        seenNames.add(name);
        
        // Determine type
        let type = tags.tourism || tags.amenity || tags.historic || tags.leisure || tags.shop || tags.building || 'ƒê·ªãa ƒëi·ªÉm';
        type = type.charAt(0).toUpperCase() + type.slice(1).replace(/_/g, ' ');
        
        // Get icon
        const icon = getIconForType(tags);
        
        pois.push({
          name,
          type,
          lat,
          lon,
          icon,
          description: tags.description || tags['addr:full'] || `${type} t·∫°i ${currentLocation.name.split(',')[0]}`,
          address: tags['addr:street'] || tags['addr:city'] || ''
        });
      }
      
      console.log('Processed POIs:', pois.length);
      return pois;
    }
    
    // Get icon based on POI type
    function getIconForType(tags) {
      if (tags.tourism) {
        if (tags.tourism === 'hotel') return 'üè®';
        if (tags.tourism === 'museum') return 'üèõÔ∏è';
        if (tags.tourism === 'attraction') return '‚≠ê';
        if (tags.tourism === 'viewpoint') return 'üëÅÔ∏è';
        if (tags.tourism === 'information') return '‚ÑπÔ∏è';
        if (tags.tourism === 'gallery') return 'üñºÔ∏è';
        return 'üéØ';
      }
      if (tags.amenity) {
        if (tags.amenity === 'restaurant') return 'üçΩÔ∏è';
        if (tags.amenity === 'cafe') return '‚òï';
        if (tags.amenity === 'museum') return 'üèõÔ∏è';
        if (tags.amenity === 'theatre') return 'üé≠';
        if (tags.amenity === 'cinema') return 'üé¨';
        if (tags.amenity === 'park') return 'üå≥';
        if (tags.amenity === 'attraction') return '‚≠ê';
        return 'üìç';
      }
      if (tags.historic) {
        if (tags.historic === 'monument') return 'üóø';
        if (tags.historic === 'castle') return 'üè∞';
        if (tags.historic === 'memorial') return '‚öîÔ∏è';
        return 'üèõÔ∏è';
      }
      if (tags.leisure) {
        if (tags.leisure === 'park') return 'üå≥';
        if (tags.leisure === 'garden') return 'üå∫';
        if (tags.leisure === 'beach_resort') return 'üèñÔ∏è';
        return 'üéÆ';
      }
      return 'üìç';
    }
    
    // Display POIs on map and list
    function displayPOIs(pois) {
      poiList.innerHTML = '';
      if (pois.length === 0) {
        showError('Kh√¥ng t√¨m th·∫•y ƒëi·ªÉm th√∫ v·ªã n√†o. Th·ª≠ ƒë·ªãa ƒëi·ªÉm kh√°c!');
        return;
      }
      
      poiSection.classList.remove('hidden');
      
      pois.forEach((poi, index) => {
        // Add marker to map
        const marker = L.marker([poi.lat, poi.lon], {
          icon: L.divIcon({
            className: 'custom-marker',
            html: `<div class="marker-icon">${index + 1}</div>`,
            iconSize: [30, 30],
            iconAnchor: [15, 30]
          })
        }).addTo(map);
        
        marker.bindPopup(`
          <div class="p-2">
            <div class="text-lg font-bold">${poi.icon} ${poi.name}</div>
            <div class="text-sm text-gray-600">${poi.type}</div>
            <div class="text-xs text-gray-500 mt-1">${poi.description}</div>
          </div>
        `);
        
        markers.push(marker);
        
        // Add to list
        const card = document.createElement('div');
        card.className = 'poi-card bg-gradient-to-br from-white to-gray-50 border-2 border-gray-200 rounded-xl p-5 cursor-pointer hover:shadow-xl';
        card.innerHTML = `
          <div class="flex items-start gap-4">
            <div class="text-4xl flex-shrink-0">${poi.icon}</div>
            <div class="flex-1 min-w-0">
              <div class="font-bold text-gray-900 text-lg mb-1 truncate">${index + 1}. ${poi.name}</div>
              <div class="inline-block px-2 py-1 bg-blue-100 text-blue-700 text-xs font-semibold rounded-full mb-2">${poi.type}</div>
              <div class="text-sm text-gray-600 line-clamp-2">${poi.description}</div>
            </div>
          </div>
          <div class="mt-3 pt-3 border-t border-gray-200 text-xs text-gray-500 flex items-center gap-1">
            <span>üëÜ</span>
            <span>Click ƒë·ªÉ xem tr√™n b·∫£n ƒë·ªì</span>
          </div>
        `;
        
        card.addEventListener('click', () => {
          map.setView([poi.lat, poi.lon], 16);
          marker.openPopup();
        });
        
        poiList.appendChild(card);
      });
      
        // Fit map bounds to show all markers
      if (markers.length > 0) {
        const group = new L.featureGroup(markers);
        map.fitBounds(group.getBounds().pad(0.1));
      }
      
      // Cache the results
      if (currentLocation && locationInput.value.trim()) {
        searchCache.set(locationInput.value.trim().toLowerCase(), {
          location: currentLocation,
          pois: pois,
          weather: searchCache.get(locationInput.value.trim().toLowerCase())?.weather
        });
      }
    }    // Clear all markers
    function clearMarkers() {
      markers.forEach(marker => map.removeLayer(marker));
      markers = [];
    }
    
    // Show error message
    function showError(message) {
      errorMsg.textContent = message;
      errorMsg.classList.remove('hidden');
    }
    
    // Hide error message
    function hideError() {
      errorMsg.classList.add('hidden');
    }
    
    // Event listeners
    searchBtn.addEventListener('click', searchLocation);
    
    locationInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        searchLocation();
      }
    });
    
    // Quick search buttons
    document.querySelectorAll('.quick-search').forEach(btn => {
      btn.addEventListener('click', () => {
        locationInput.value = btn.dataset.location;
        searchLocation();
      });
    });
    
    // Debug panel toggle
    document.addEventListener('keydown', (e) => {
      if (e.ctrlKey && e.shiftKey && e.key === 'D') {
        const panel = document.getElementById('debugPanel');
        panel.classList.toggle('hidden');
      }
    });
    
    // Override console.log to show in debug panel
    const originalLog = console.log;
    console.log = function(...args) {
      originalLog.apply(console, args);
      const debugContent = document.getElementById('debugContent');
      if (debugContent) {
        const msg = args.map(a => typeof a === 'object' ? JSON.stringify(a, null, 2) : a).join(' ');
        debugContent.innerHTML += `<div class="border-t border-gray-700 pt-1 mt-1">${msg}</div>`;
        debugContent.scrollTop = debugContent.scrollHeight;
      }
    };

    // --- Translation feature (calls backend) ---
    const TRANSLATE_API = 'http://localhost:5001/translate'; // backend now runs on 5001
    const translateBtn = document.getElementById('translateBtn');
    const clearTranslateBtn = document.getElementById('clearTranslateBtn');
    const translateInput = document.getElementById('translateInput');
    const translateResult = document.getElementById('translateResult');
    const translatedText = document.getElementById('translatedText');
    const copyTranslateBtn = document.getElementById('copyTranslateBtn');
    const openInNewBtn = document.getElementById('openInNewBtn');

    async function doTranslate() {
      const text = (translateInput.value || '').trim();
      if (!text) return;
      translateBtn.disabled = true;
      translateBtn.textContent = 'ƒêang d·ªãch...';
      translateResult.classList.add('hidden');
      try {
        const resp = await fetch(TRANSLATE_API, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ text })
        });
        const data = await resp.json();
        if (!resp.ok) throw new Error(data.error || 'L·ªói d·ªãch');
        translatedText.textContent = data.translated;
        translateResult.classList.remove('hidden');
      } catch (err) {
        alert('L·ªói d·ªãch: ' + err.message);
      } finally {
        translateBtn.disabled = false;
        translateBtn.textContent = 'D·ªãch';
      }
    }

    translateBtn.addEventListener('click', doTranslate);
    translateInput.addEventListener('keydown', (e) => { if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) doTranslate(); });
    clearTranslateBtn.addEventListener('click', () => {
      translateInput.value = '';
      translatedText.textContent = '';
      translateResult.classList.add('hidden');
      translateInput.focus();
    });
    copyTranslateBtn.addEventListener('click', async () => {
      try { await navigator.clipboard.writeText(translatedText.textContent || ''); alert('ƒê√£ sao ch√©p'); }
      catch { alert('Kh√¥ng th·ªÉ sao ch√©p'); }
    });
    openInNewBtn.addEventListener('click', () => {
      const url = 'https://translate.google.com/?sl=en&tl=vi&text=' + encodeURIComponent(translateInput.value || '') + '&op=translate';
      window.open(url, '_blank');
    });
    
    // Example searches (optional demo)
    console.log('V√≠ d·ª• ƒë·ªãa ƒëi·ªÉm b·∫°n c√≥ th·ªÉ t√¨m:');
    console.log('- H√† N·ªôi');
    console.log('- H·ªôi An');
    console.log('- ƒê√† N·∫µng');
    console.log('- Nha Trang');
    console.log('- Ph·ªë c·ªï H√† N·ªôi');

    // Quick Translator (EN ‚Üí VI) functionality with fallback endpoints and improved error handling
    try {
      const txtToTranslate = document.getElementById('txtToTranslate');
      const btnTranslate = document.getElementById('btnTranslate');
      const btnClear = document.getElementById('btnClear');
      const translateStatus = document.getElementById('translateStatus');
      const translateResult = document.getElementById('translateResult');
      const translatedText = document.getElementById('translatedText');

      // Try backend proxy first (if running locally), then public endpoints
      const TRANSLATE_ENDPOINTS = [
        'http://localhost:8001/api/translate', // local FastAPI proxy (recommended)
        'https://translate.argosopentech.com/translate',
        'https://libretranslate.com/translate'
      ];

      async function translateText(text) {
        const payload = { q: text, source: 'en', target: 'vi', format: 'text' };

        for (const url of TRANSLATE_ENDPOINTS) {
          try {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 10000); // 10s

            // If calling our local backend proxy, it expects same JSON shape but on a different URL
            const isLocalProxy = url.startsWith('http://localhost');
            const fetchOptions = {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload),
              signal: controller.signal
            };

            const res = await fetch(url, fetchOptions);
            clearTimeout(timeoutId);

            // If 400, try to read JSON error details and include them
            if (res.status === 400) {
              let bodyText = '';
              try { bodyText = await res.text(); } catch (e) { /* ignore */ }
              throw new Error(`400 Bad Request from ${url}: ${bodyText}`);
            }

            if (!res.ok) {
              throw new Error(`${res.status} ${res.statusText} from ${url}`);
            }

            const json = await res.json();
            // LibreTranslate returns { translatedText }, Argos returns { translatedText }
            return json.translatedText || json.result || '';
          } catch (err) {
            console.warn('Translate endpoint failed', url, err && err.message ? err.message : err);
            // try next endpoint
          }
        }

        throw new Error('All translation endpoints failed (CORS/rate-limit/network).');
      }

      if (btnTranslate && txtToTranslate) {
        btnTranslate.addEventListener('click', async () => {
          const text = (txtToTranslate.value || '').trim();
          if (!text) return;
          btnTranslate.disabled = true;
          translateStatus.textContent = 'ƒêang d·ªãch...';
          translateStatus.classList.remove('hidden');
          translateResult.classList.add('hidden');

          try {
            const result = await translateText(text);
            translatedText.textContent = result || '(Kh√¥ng c√≥ k·∫øt qu·∫£)';
            translateResult.classList.remove('hidden');
            translateStatus.textContent = 'Ho√†n th√†nh';
            setTimeout(() => translateStatus.classList.add('hidden'), 1400);
          } catch (err) {
            console.error('Translate error', err);
            translateStatus.textContent = 'L·ªói d·ªãch: ' + (err.message || 'Kh√¥ng th·ªÉ d·ªãch');
          } finally {
            btnTranslate.disabled = false;
          }
        });

        btnClear.addEventListener('click', () => {
          txtToTranslate.value = '';
          translatedText.textContent = '';
          translateResult.classList.add('hidden');
          translateStatus.classList.add('hidden');
        });
      }
    } catch (e) {
      console.warn('Quick translator init failed', e);
    }
  </script>
</body>
</html>
